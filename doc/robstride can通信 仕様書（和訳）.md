## **Rob-Stride モーター CAN通信仕様書**

本文書は、AIによって生成されたコンテンツを含みます。内容は不正確な可能性があります。

---

### **1\. 通信基本仕様**

モーターとの通信は、CAN 2.0インターフェースを介して行われます 11。基本的な仕様は以下の通りです。

* **インターフェース**: CAN 2.0

* **ボーレート**: 1Mbps

* **フレーム形式**: 拡張フレーム (Extended Frame)

---

### **2\. フレーム構造**

プライベートプロトコルは、29ビットのIDと8バイトのデータフィールドで構成されます。

#### **2.1.**

29ビットIDの構成

| ビット範囲 | 名称 | 説明 |
| :---- | :---- | :---- |
| **Bit 28-24** | 通信タイプ | 送信するコマンドの種類を定義します 7。  |
| **Bit 23-8** | データエリア2 | コマンドに応じて使用されるデータ領域です 8。  |
| **Bit 7-0** | 宛先アドレス | コマンドの対象となるモーターのCAN IDです 9。  |

#### **2.2. 8バイトデータフィールド**

データエリア1として、コマンドの主要なパラメータを格納します。

---

### **3\. 通信タイプとコマンド**

プライベートプロトコルで使用される主要な通信タイプと、その機能について説明します。

| タイプ | コマンド名 | 機能概要 |
| :---- | :---- | :---- |
| 0 | **デバイスIDの取得** | モーターのCAN IDと64ビットのMCUユニークIDを取得します。  |
| 1 | **操作制御モード命令** | モーターの5つのパラメータ（目標角度、目標角速度、Kp、Kd、トルク）を一度に設定します 。詳細は後述します。  |
| 2 | **モーターフィードバック** | モーターの現在の角度、角速度、トルク、温度などの情報を返します。  |
| 3 | **モーターの運転有効化** | モーターを運転可能な状態（Enable）にします。  |
| 4 | **モーターの運転停止** | モーターの運転を停止し、無効化状態（Disable）にします 。  |
| 6 | **機械的ゼロ点設定** | 現在のモーター位置を機械的なゼロ点として設定します。  |
| 7 | **CAN ID設定** | モーターのCAN IDを変更します。設定は即座に反映されます。  |
| 17 | **単一パラメータ読み取り** | パラメータリストに基づき、指定したインデックスのパラメータを1つ読み取ります。  |
| 18 | **単一パラメータ書き込み** | パラメータリストに基づき、指定したインデックスのパラメータを1つ書き込みます。この設定は電源OFFで失われます。  |
| 21 | **故障フィードバック** | モーターの故障状態を報告しま。  |
| 22 | **モーターデータ保存** | タイプ18で書き込んだ設定値（インデックス0x2000番台）を不揮発性メモリに保存しま。 |
| 23 | **ボーレート変更** | CAN通信のボーレートを変更します。設定は再電源投入後に有効になります。  |
| 24 | **アクティブレポート設定** | モーターがフィードバックデータを能動的に送信するかどうかを設定します。  |
| 25 | **モータープロトコル変更** | 通信プロトコルを変更します（プライベート/CANopen/MIT）。設定は再電源投入後に有効になります。  |

#### **コマンド詳細**

##### **◆ タイプ1: 操作制御モード命令**

5つのパラメータ（目標角度、目標角速度、Kp、Kd、トルク）を同時に指令するモードです 26。

* **8バイトデータフィールド（データエリア1**:

  * **Byte 0-1:** 目標角度 \[0\~65535\] (-4π\~4πに対応)

  * **Byte 2-3:** 目標角速度 \[0\~65535\] (-33rad/s\~33rad/sに対応)

  * **Byte 4-5:** Kp \[0\~65535\] (0.0\~500.0に対応)

  * **Byte 6-7:** Kd \[0\~65535\] (0.0\~5.0に対応)

* **29ビットID（データエリア2）**:  
  * **Bit 23-8:** トルク \[0\~65535\] (-14Nm\~14Nmに対応)

---

### **4\. 制御モード別手順**

各運転モード（

run\_mode）を使用するための厳密な手順を説明します。モードの切り替えは、必ずモーターが\*\*無効化（Disable）\*\*されている状態で行う必要があります。

#### **4.1. 位置モード (PP \- Profile Position)**

指定された速度と加速度で目標位置まで移動させるモードです。

1. **運転モード設定（無効化状態）**: タイプ18コマンドで run\_mode (0x7005) の値を 1 (位置モードPP) に設定します。

2. **モーター有効化**: タイプ3コマンドを送信し、モーターを\*\*有効化（Enable）\*\*します。

3. **動作パラメータ設定（有効化状態）**: モーターが**有効化された後**、タイプ18コマンドで以下のパラメータを順番に設定します。

   * vel\_max (0x7024): 最大速度

   * acc\_set (0x7025): 加速度

4. **目標位置指令**: タイプ18コマンドで loc\_ref (0x7016) に目標位置 \[rad\] を設定すると、モーターが動作を開始します。

#### **4.2. 速度モード (Velocity Mode)**

指定された回転速度で動作させるモードです。

1. **運転モード設定（無効化状態）**: タイプ18コマンドで run\_mode (0x7005) の値を 2 (速度モード) に設定します。

2. **モーター有効化**: タイプ3コマンドを送信し、モーターを\*\*有効化（Enable）\*\*します。

3. **動作パラメータ設定（有効化状態）**: モーターが**有効化された後**、タイプ18コマンドで以下のパラメータを設定します。

   * limit\_cur (0x7018): 電流制限

   * acc\_rad (0x7022): 加速度

4. **目標速度指令**: タイプ18コマンドで spd\_ref (0x700A) に目標速度 \[rad/s\] を設定すると、モーターが動作を開始します。

#### **4.3. 電流モード (Current Mode)**

モーターに流す電流（トルク）を直接指令するモードです。

1. **運転モード設定（無効化状態）**: タイプ18コマンドで run\_mode (0x7005) の値を 3 (電流モード) に設定します。

2. **モーター有効化**: タイプ3コマンドを送信し、モーターを\*\*有効化（Enable）\*\*します。

3. **目標電流指令（有効化状態）**: モーターが**有効化された後**、タイプ18コマンドで iq\_ref (0x7006) に目標電流 \[A\] を設定します。

#### **4.4. 位置モード (CSP \- Cyclic Synchronous Position)**

周期的に目標位置を指令するモードです。

1. **運転モード設定（無効化状態）**: タイプ18コマンドで run\_mode (0x7005) の値を 5 (位置モードCSP) に設定します。

2. **モーター有効化**: タイプ3コマンドを送信し、モーターを\*\*有効化（Enable）\*\*します。

3. **動作パラメータ設定（有効化状態）**: モーターが**有効化された後**、タイプ18コマンドで limit\_spd (0x7017) の値を設定し、最大速度を制限します。

4. **目標位置指令**: タイプ18コマンドで loc\_ref (0x7016) に目標位置 \[rad\] を設定すると、モーターが動作を開始します。

---

### **5\. 故障と保護**

#### **5.1. CAN通信タイムアウト保護**

CAN\_TIMEOUT パラメータ（インデックス 0x7028）を使用して、通信のタイムアウト保護を設定できます。

* **値が 0 の場合**: この機能は無効です。

* **値が 0 以外の場合**: モーターが設定された時間内にCANコマンドを受信しないと、リセットモードに入ります。

  20000 が 1 秒に相当します。

#### **5.2. 故障フィードバック（タイプ21）**

モーターで故障が発生すると、故障フィードバックフレームが送信されます 61。故障の詳細はインデックス

0x3022 で確認でき、各ビットが特定の故障内容を示します。

| ビット | 故障内容 | 詳細 |
| :---- | :---- | :---- |
| bit14 | **I²t過負荷故障** | モーターの拘束などによる過負荷を検出しました 。  |
| bit7 | **エンコーダー未校正** | エンコーダーが校正されていません。  |
| bit3 | **過電圧故障** | モーター電圧が保護電圧（60V）を超えました。  |
| bit2 | **低電圧故障** | モーター電圧が保護電圧（12V）を下回りました。  |
| bit1 | **ドライバーチップ故障** | モータードライバーチップが故障を報告しました。  |
| bit0 | **モーター過熱故障** | サーミスタ温度が145℃を超えました。  |

---

### **6\. 主要な読み書き可能パラメータリスト**

タイプ17（読み取り）およびタイプ18（書き込み）コマンドで使用する主要なパラメータは以下の通りです。

| インデックス | 名前 | 説明 | 型 | 範囲 / 単位 |
| :---- | :---- | :---- | :---- | :---- |
| 0x7005 | run\_mode | 運転モードを設定します。\<br\>0: 操作モード, 1: 位置モード(PP), 2: 速度モード, 3: 電流モード, 5: 位置モード(CSP) | uint8 | \- |
| 0x7006 | iq\_ref | 電流モードのIq指令値。 | float | \-16 ～ 16 A  |
| 0x700A | spd\_ref | 速度モードの回転速度指令値。 | float | \-33 ～ 33 rad/s  |
| 0x7010 | cur\_kp | 電流ループの比例ゲイン(Kp)。 | float | デフォルト: 0.17   |
| 0x7011 | cur\_ki | 電流ループの積分ゲイン(Ki)。 | float | デフォルト: 0.012   |
| 0x7016 | loc\_ref | 位置モードの角度指令値。 | float | rad  |
| 0x7017 | limit\_spd | 位置モード(CSP)の速度制限。 | float | 0 ～ 33 rad/s  |
| 0x7018 | limit\_cur | 速度・位置モードの電流制限。 | float | 0 ～ 16 A  |
| 0x701E | loc\_kp | 位置ループの比例ゲイン(Kp)。 | float | デフォルト: 40  |
| 0x701F | spd\_kp | 速度ループの比例ゲイン(Kp)。 | float | デフォルト: 6  |
| 0x7020 | spd\_ki | 速度ループの積分ゲイン(Ki)。 | float | デフォルト: 0.02  |
| 0x7022 | acc\_rad | 速度モードの加速度。 | float | デフォルト: 20 rad/s²  |
| 0x7024 | vel\_max | 位置モード(PP)の速度。 | float | デフォルト: 10 rad/s  |
| 0x7025 | acc\_set | 位置モード(PP)の加速度。 | float | デフォルト: 10 rad/s²  |
| 0x7028 | canTimeout | CANタイムアウト閾値。20000が1秒に相当します。 | uint32 | デフォルト: 0  |
| 0x7029 | zero\_sta | ゼロフラグビット。0は0～2π、1は-π～πの範囲を示します。 | uint8 | デフォルト: 0  |

